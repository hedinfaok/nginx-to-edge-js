# Example: Map Directive for Variable Mapping
# Demonstrates various map directive use cases

events {
    worker_connections 1024;
}

http {
    # Extract real IP from X-Forwarded-For header
    map $http_x_forwarded_for $realip {
        ~^(\d+\.\d+\.\d+\.\d+) $1;
        default $remote_addr;
    }

    # Country-based URL redirection
    map $http_cloudfront_viewer_country $country_path {
        US "us/";
        CA "ca/";
        GB "uk/";
        default "international/";
    }

    # Custom redirects based on request URI
    map $request_uri $custom_redirect {
        "~^/old-path/?$" "/new-path";
        "~^/legacy/(.+)$" "/modern/$1";
        default "";
    }

    # Content type mapping
    map $uri $content_type {
        ~\.json$ "application/json";
        ~\.xml$ "application/xml";
        ~\.txt$ "text/plain";
        default "text/html";
    }

    server {
        listen 80;
        server_name example.com;

        location / {
            # Use mapped variables
            add_header X-Real-IP $realip;
            add_header X-Country-Path $country_path;

            # Conditional redirect
            if ($custom_redirect != "") {
                return 301 $custom_redirect;
            }

            return 200 "Map directive examples";
        }

        location /api {
            add_header Content-Type $content_type;
            return 200 "API response with mapped content type";
        }
    }
}
