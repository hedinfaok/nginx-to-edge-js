# Example: Variable Usage and Set Directive
# Demonstrates set directive and variable manipulation

events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name example.com;
        
        location / {
            # Set simple variables
            set $backend_host "api.example.com";
            set $backend_port "8080";
            set $empty "";
            
            # Conditional variable setting
            set $mobile "false";
            if ($http_user_agent ~* "(mobile|android|iphone)") {
                set $mobile "true";
            }
            
            # Set variables based on URI
            set $api_version "v1";
            if ($uri ~ "^/api/v2/") {
                set $api_version "v2";
            }
            
            # Environment-like variables (simulating ${VAR} substitution)
            set $internal_alb "internal-alb.example.com";
            set $vpc_resolver "10.0.0.2";
            
            # Use variables in headers
            add_header X-Backend-Host $backend_host;
            add_header X-Mobile-Detected $mobile;
            add_header X-API-Version $api_version;
            
            return 200 "Variable examples: Backend=$backend_host:$backend_port, Mobile=$mobile";
        }
        
        location /proxy {
            # Use variables in proxy_pass
            set $target "backend.example.com";
            set $port "443";
            
            resolver 8.8.8.8;
            proxy_pass https://$target:$port;
            proxy_set_header Host $target;
        }
        
        location /dynamic {
            # Dynamic backend selection
            set $backend_pool "pool1";
            
            if ($arg_pool) {
                set $backend_pool $arg_pool;
            }
            
            if ($backend_pool = "pool2") {
                set $target_host "pool2.example.com";
            }
            if ($backend_pool = "pool1") {
                set $target_host "pool1.example.com";
            }
            
            proxy_pass http://$target_host;
            proxy_set_header Host $target_host;
        }
        
        location /rewrite-with-vars {
            # Use variables in rewrites
            set $new_path "/api/v2";
            
            if ($args ~ "legacy=true") {
                set $new_path "/api/v1";
            }
            
            rewrite ^/rewrite-with-vars(.*)$ $new_path$1 break;
            proxy_pass http://backend;
        }
        
        location /headers {
            # Complex header manipulation with variables
            set $custom_header_value "default";
            
            if ($http_x_client_type = "mobile") {
                set $custom_header_value "mobile-client";
            }
            if ($http_x_client_type = "desktop") {
                set $custom_header_value "desktop-client";
            }
            
            proxy_set_header X-Client-Context $custom_header_value;
            proxy_set_header X-Request-ID $request_id;
            proxy_pass http://backend;
        }
    }
}
